package com.springboot.service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.springboot.dto.VentaDto;
import com.springboot.entity.DetalleVentaEntity;
import com.springboot.entity.VentaEntity;
import com.springboot.repository.VentaRepository;

import jakarta.transaction.Transactional;

@Service
@Transactional
public class VentaService 
{
	@Autowired
    private VentaRepository ventaRepository;

	
	public VentaDto registrarVenta(VentaDto ventaDto) {
        VentaEntity venta = convertirADto(ventaDto);
        venta = ventaRepository.save(venta);
        return convertirADto(venta);
    }

    public List<VentaDto> listarVentas() {
        return ventaRepository.findAll().stream()
            .map(this::convertirADto)
            .collect(Collectors.toList());
    }

    private VentaEntity convertirADto(VentaDto ventaDto) {
        VentaEntity venta = new VentaEntity();
        venta.setIdVenta(ventaDto.getIdVenta());
        venta.setFechaVenta(ventaDto.getFechaVenta());
        venta.setTotalVenta(ventaDto.getTotalVenta());

        // Manejar la conversión de detalles de venta
        if (ventaDto.getDetallesVenta() != null) {
            List<DetalleVentaEntity> detalles = new ArrayList<>();
            for (VentaDto.DetalleVentaDto detalleDto : ventaDto.getDetallesVenta()) {
                DetalleVentaEntity detalle = new DetalleVentaEntity();
                detalle.setIdDetalleVenta(detalleDto.getIdDetalleVenta());
                detalle.setCantidad(detalleDto.getCantidad());
                detalle.setPrecioVenta(detalleDto.getPrecioVenta());
                detalle.setVentaEntity(venta); // Vincular detalle a la venta
                detalles.add(detalle);
            }
            venta.setDetallesVentaEntity(detalles); // Asigna la lista de detalles a la venta
        }

        return venta;
    }

    private VentaDto convertirADto(VentaEntity venta) {
        VentaDto dto = new VentaDto();
        dto.setIdVenta(venta.getIdVenta());
        dto.setFechaVenta(venta.getFechaVenta());
        dto.setTotalVenta(venta.getTotalVenta());

        // Manejar la conversión de detalles de venta
        if (venta.getDetallesVentaEntity() != null) {
            List<VentaDto.DetalleVentaDto> detallesDto = venta.getDetallesVentaEntity().stream()
                .map(detalle -> {
                    VentaDto.DetalleVentaDto detalleDto = new VentaDto.DetalleVentaDto();
                    detalleDto.setIdDetalleVenta(detalle.getIdDetalleVenta());
                    detalleDto.setCantidad(detalle.getCantidad());
                    detalleDto.setPrecioVenta(detalle.getPrecioVenta());
                    return detalleDto;
                })
                .collect(Collectors.toList());
            dto.setDetallesVenta(detallesDto);
        }

        return dto;
    }
}
